name: Render Keep-Alive

on:
  schedule:
    # æ¯ 10 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆRender å…è´¹ç‰ˆ 15 åˆ†é’Ÿä¸æ´»åŠ¨ä¼šç¡çœ ï¼‰
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Ping Render App
        env:
          RENDER_APP_URL: ${{ secrets.RENDER_APP_URL }}
        run: |
          import os
          import sys
          import requests
          from datetime import datetime
          
          url = os.getenv('RENDER_APP_URL', '').strip()
          if not url:
              print('âŒ RENDER_APP_URL secret æœªè®¾ç½®')
              print('è¯·åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ  secret: RENDER_APP_URL')
              print('å€¼åº”è¯¥æ˜¯: https://ä½ çš„åº”ç”¨å.onrender.com')
              sys.exit(1)
          
          # ç¡®ä¿ URL æœ‰åè®®
          if not url.startswith(('http://', 'https://')):
              url = f'https://{url}'
          
          url = url.rstrip('/')
          
          # å°è¯•å¤šä¸ªç«¯ç‚¹
          endpoints = [
              '/api/health',  # å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼ˆä¼˜å…ˆï¼‰
              '/',            # é¦–é¡µ
          ]
          
          success = False
          for endpoint in endpoints:
              try:
                  full_url = url + endpoint
                  print(f'â±ï¸  [{datetime.now().strftime("%Y-%m-%d %H:%M:%S")}] Pinging {full_url}...')
                  
                  response = requests.get(
                      full_url,
                      headers={
                          'User-Agent': 'SPR-KeepAlive/GitHub-Actions',
                          'Cache-Control': 'no-cache',
                      },
                      timeout=30,
                      allow_redirects=True
                  )
                  
                  print(f'ğŸ“Š çŠ¶æ€ç : {response.status_code}')
                  
                  if response.status_code == 200:
                      print(f'âœ… Ping æˆåŠŸ! ç«¯ç‚¹: {endpoint}')
                      success = True
                      break
                  else:
                      print(f'âš ï¸  ç«¯ç‚¹ {endpoint} è¿”å›çŠ¶æ€ç  {response.status_code}')
                      
              except requests.exceptions.Timeout:
                  print(f'â±ï¸  è¯·æ±‚è¶…æ—¶ (ç«¯ç‚¹: {endpoint})')
              except requests.exceptions.RequestException as e:
                  print(f'âŒ è¯·æ±‚å¤±è´¥ (ç«¯ç‚¹: {endpoint}): {e}')
          
          if not success:
              print('âŒ æ‰€æœ‰ç«¯ç‚¹éƒ½å¤±è´¥äº†')
              sys.exit(1)
          
          print(f'âœ… Keep-Alive å®Œæˆäº {datetime.now().strftime("%Y-%m-%d %H:%M:%S UTC")}')
        shell: python
