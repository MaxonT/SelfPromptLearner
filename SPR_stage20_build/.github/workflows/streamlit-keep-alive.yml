name: Streamlit Keep-Alive

on:
  schedule:
    # æ¯ 3 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆç¡®ä¿ Streamlit ä¸ä¼šç¡çœ ï¼‰
    - cron: '*/3 * * * *'
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests --quiet
      
      - name: Run Keep-Alive ping
        env:
          STREAMLIT_APP_URL: ${{ secrets.STREAMLIT_APP_URL }}
          API_URL: ${{ secrets.API_URL }}
          API_TOKEN: ${{ secrets.API_TOKEN }}
        run: |
          import os
          import sys
          import requests
          from datetime import datetime
          
          print('='*60)
          print('ğŸš€ Streamlit Keep-Alive å¼€å§‹è¿è¡Œ')
          print(f'â° æ—¶é—´: {datetime.now().strftime("%Y-%m-%d %H:%M:%S UTC")}')
          print('='*60)
          
          url = os.getenv('STREAMLIT_APP_URL', '').strip()
          if not url:
              print('âŒ é”™è¯¯: STREAMLIT_APP_URL Secret æœªè®¾ç½®!')
              print('')
              print('ğŸ“ è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤è®¾ç½®:')
              print('1. æ‰“å¼€ GitHub ä»“åº“é¡µé¢')
              print('2. Settings â†’ Secrets and variables â†’ Actions')
              print('3. New repository secret')
              print('4. Name: STREAMLIT_APP_URL')
              print('5. Secret: https://ä½ çš„åº”ç”¨å.streamlit.app')
              print('')
              print('âš ï¸  è·³è¿‡æ­¤æ¬¡è¿è¡Œ...')
              sys.exit(0)
          
          # ç¡®ä¿ URL æœ‰åè®®
          if not url.startswith(('http://', 'https://')):
              url = f'https://{url}'
          
          print(f'ğŸ“ ç›®æ ‡åº”ç”¨: {url}')
          print('')
          
          try:
              print(f'â±ï¸  æ­£åœ¨ ping...')
              response = requests.get(
                  url,
                  headers={
                      'User-Agent': 'SPR-KeepAlive/GitHub-Actions',
                      'Cache-Control': 'no-cache',
                  },
                  timeout=30,  # å¢åŠ è¶…æ—¶æ—¶é—´åˆ° 30 ç§’
                  allow_redirects=True
              )
              
              print(f'ğŸ“Š HTTP çŠ¶æ€ç : {response.status_code}')
              print(f'ğŸ“ å“åº”å¤§å°: {len(response.content)} bytes')
              
              if response.status_code == 200:
                  print('')
                  print('âœ… Ping æˆåŠŸ! Streamlit åº”ç”¨ä¿æŒæ´»è·ƒçŠ¶æ€')
                  print('')
                  
                  # å°è¯•åç«¯ API heartbeatï¼ˆå¯é€‰ï¼‰
                  api_url = os.getenv('API_URL', '').strip()
                  if api_url and os.getenv('API_TOKEN'):
                      try:
                          print('ğŸ”„ å°è¯•å‘é€åç«¯å¿ƒè·³...')
                          api_response = requests.post(
                              f'{api_url.rstrip("/")}/api/extension/status',
                              json={
                                  'deviceId': 'github-actions-keep-alive',
                                  'pending': 0,
                                  'sending': 0,
                                  'failed': 0,
                              },
                              headers={'Authorization': f'Bearer {os.getenv("API_TOKEN")}'},
                              timeout=10
                          )
                          print(f'âœ… åç«¯å¿ƒè·³æˆåŠŸ: {api_response.status_code}')
                      except Exception as e:
                          print(f'âš ï¸  åç«¯å¿ƒè·³å¤±è´¥ (ä¸å½±å“ä¸»è¦åŠŸèƒ½): {e}')
              elif response.status_code in [301, 302, 307, 308]:
                  print(f'â†ªï¸  é‡å®šå‘åˆ°: {response.headers.get("Location", "æœªçŸ¥")}')
                  print('âœ… åº”ç”¨å“åº”æ­£å¸¸ï¼ˆé‡å®šå‘ï¼‰')
              else:
                  print(f'âš ï¸  æ„å¤–çš„ HTTP çŠ¶æ€ç : {response.status_code}')
                  print('ğŸ’¡ åº”ç”¨å¯èƒ½æ­£åœ¨å¯åŠ¨æˆ–é‡åˆ°é—®é¢˜ï¼Œä½†è¯·æ±‚å·²å‘é€')
                  
          except requests.exceptions.Timeout:
              print('â±ï¸  è¯·æ±‚è¶…æ—¶ (30ç§’)')
              print('ğŸ’¡ è¿™å¯èƒ½æ˜¯å› ä¸º:')
              print('   - Streamlit åº”ç”¨æ­£åœ¨å†·å¯åŠ¨')
              print('   - åº”ç”¨å“åº”è¾ƒæ…¢')
              print('   - ç½‘ç»œé—®é¢˜')
              print('')
              print('âš ï¸  ä¸ç®—å¤±è´¥ï¼Œä¸‹æ¬¡ä¼šç»§ç»­å°è¯•')
          except requests.exceptions.RequestException as e:
              print(f'âŒ è¯·æ±‚å¤±è´¥: {e}')
              print('')
              print('ğŸ’¡ å¯èƒ½çš„åŸå› :')
              print('   - STREAMLIT_APP_URL è®¾ç½®ä¸æ­£ç¡®')
              print('   - Streamlit åº”ç”¨æœªè¿è¡Œ')
              print('   - ç½‘ç»œè¿æ¥é—®é¢˜')
              print('')
              # ä¸è¦ exit(1)ï¼Œå› ä¸ºä¸´æ—¶ç½‘ç»œé—®é¢˜ä¸åº”è¯¥å¯¼è‡´ workflow å¤±è´¥
              print('âš ï¸  æ ‡è®°ä¸ºè­¦å‘Šï¼Œç»§ç»­ç›‘æ§...')
              
          print('')
          print('='*60)
          print('âœ… Keep-Alive å‘¨æœŸå®Œæˆ')
          print('â° ä¸‹æ¬¡è¿è¡Œ: 3 åˆ†é’Ÿå')
          print('='*60)
        shell: python
      
      - name: Log completion
        run: echo "âœ… Keep-Alive cycle completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
